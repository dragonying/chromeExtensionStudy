const t=new BroadcastChannel("douzhencang"),n=new BroadcastChannel("params-guard"),e=(t,n)=>n.some((n=>t instanceof n));let o,i;const a=new WeakMap,r=new WeakMap,s=new WeakMap,c=new WeakMap,u=new WeakMap;let d={get(t,n,e){if(t instanceof IDBTransaction){if("done"===n)return r.get(t);if("objectStoreNames"===n)return t.objectStoreNames||s.get(t);if("store"===n)return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return w(t[n])},set:(t,n,e)=>(t[n]=e,!0),has:(t,n)=>t instanceof IDBTransaction&&("done"===n||"store"===n)||n in t};function l(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(i||(i=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...n){return t.apply(h(this),n),w(a.get(this))}:function(...n){return w(t.apply(h(this),n))}:function(n,...e){const o=t.call(h(this),n,...e);return s.set(o,n.sort?n.sort():[n]),w(o)}}function f(t){return"function"==typeof t?l(t):(t instanceof IDBTransaction&&function(t){if(r.has(t))return;const n=new Promise(((n,e)=>{const o=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",a),t.removeEventListener("abort",a)},i=()=>{n(),o()},a=()=>{e(t.error||new DOMException("AbortError","AbortError")),o()};t.addEventListener("complete",i),t.addEventListener("error",a),t.addEventListener("abort",a)}));r.set(t,n)}(t),e(t,o||(o=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(t,d):t)}function w(t){if(t instanceof IDBRequest)return function(t){const n=new Promise(((n,e)=>{const o=()=>{t.removeEventListener("success",i),t.removeEventListener("error",a)},i=()=>{n(w(t.result)),o()},a=()=>{e(t.error),o()};t.addEventListener("success",i),t.addEventListener("error",a)}));return n.then((n=>{n instanceof IDBCursor&&a.set(n,t)})).catch((()=>{})),u.set(n,t),n}(t);if(c.has(t))return c.get(t);const n=f(t);return n!==t&&(c.set(t,n),u.set(n,t)),n}const h=t=>u.get(t);const v=["get","getKey","getAll","getAllKeys","count"],y=["put","add","delete","clear"],m=new Map;function p(t,n){if(!(t instanceof IDBDatabase)||n in t||"string"!=typeof n)return;if(m.get(n))return m.get(n);const e=n.replace(/FromIndex$/,""),o=n!==e,i=y.includes(e);if(!(e in(o?IDBIndex:IDBObjectStore).prototype)||!i&&!v.includes(e))return;const a=async function(t,...n){const a=this.transaction(t,i?"readwrite":"readonly");let r=a.store;return o&&(r=r.index(n.shift())),(await Promise.all([r[e](...n),i&&a.done]))[0]};return m.set(n,a),a}d=(t=>({...t,get:(n,e,o)=>p(n,e)||t.get(n,e,o),has:(n,e)=>!!p(n,e)||t.has(n,e)}))(d);const g={t:location.hostname.includes("douyinpic.com")?null:function(t,n,{blocked:e,upgrade:o,blocking:i,terminated:a}={}){const r=indexedDB.open(t,n),s=w(r);return o&&r.addEventListener("upgradeneeded",(t=>{o(w(r.result),t.oldVersion,t.newVersion,w(r.transaction))})),e&&r.addEventListener("blocked",(()=>e())),s.then((t=>{a&&t.addEventListener("close",(()=>a())),i&&t.addEventListener("versionchange",(()=>i()))})).catch((()=>{})),s}("douzhencang",2,{upgrade(t,n,e,o){switch(n){case 0:case 1:t.createObjectStore("misc")}}})},_={o:async t=>(await g.t).get("misc",t),i:async(t,n)=>(await g.t).put("misc",n,t)};async function b(t){const n=[];for await(const e of t.keys())n.push(e);return 0===n.length}async function k(t,n,e=!0){try{const o=n.split("/");let i=t;for(const t of o)i=await i.getDirectoryHandle(t,{create:e});return i}catch(t){throw gt(t,"gfh23"),t}}async function S(t,n,e=!0){try{const o=n.split("/"),i=o.pop();let a=t;for(const t of o)a=await a.getDirectoryHandle(t,{create:!0});return await a.getFileHandle(i,{create:e})}catch(t){if("NotFoundError"===t.name&&!e)return;throw gt(t,"gfh29"),t}}async function D(t,n){const e=await t.createWritable();await e.write(n),await e.close()}async function I(t,n){const e=await async function(t){const n=await t.getFile();return await n.arrayBuffer()}(t);await D(n,e)}async function O(t){try{const n=await k(t,"data/.appdata"),e=await S(n,"app.js",!1),o=await S(n,"db.js",!1);if(!e||!o)return;const i=await k(n,"备份"),a=await k(i,function(){const t=new Date,n=String(t.getFullYear()),e=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${e}-${o}`}()),r=await b(a);if(!r)return;const s=[];for await(const t of n.keys()){if(!t.endsWith(".js"))continue;const e=await S(n,t,!1),o=await S(a,t);s.push(I(e,o))}await Promise.all(s),bt("backupsReadme"),async function(t){const n=[];for await(const e of t.keys())n.push(e);const e=n.filter((t=>/^\d{4}-\d{2}-\d{2}$/.test(t)));e.length>10&&await t.removeEntry(e.sort()[0],{recursive:!0})}(i)}catch(t){gt(t,"bu31","silently")}}async function j(){try{await async function(){const t=await k(dt.u,"data/.appdata");let n=0;for await(const e of t.keys())e.endsWith(".crswap")&&n++;return n}()>3?await bt("crswapReadme"):async function(){const t=await k(dt.u,"data/.appdata");await S(t,"crswap说明.txt",!1)&&await t.removeEntry("crswap说明.txt")}()}catch(t){gt(t,"hcf31","silently")}}const E={schemaVersion:5,user:{uid:"",id:"",uniqueId:"",nickname:""},authors:{},videos:{},videoDescriptions:{},likes:{downloadStatus:"unset",total:0,numDisappeared:0,masterList:[],downloaded:new Set,disappeared:new Set,lastRun:{start:0,finish:0}},bookmarked:{masterList:[],downloaded:new Set,disappeared:new Set,total:0,numDisappeared:0,lastRun:{start:0,finish:0}},following:{officialAuthorList:new Set,started:new Set,notInterested:new Set,authorItems:{},lastRun:{}}},T="背𓄹剃",B="⑀⦃";function x(t,n){return n instanceof Set?[...n]:"string"==typeof n?n.replaceAll("`",T).replaceAll("${",B):n}function C(t,n){switch(t){case"downloaded":case"disappeared":case"notInterested":case"started":case"officialAuthorList":case"inFolder":if(Array.isArray(n))return new Set(n)}return"string"==typeof n?n.replaceAll(B,"${").replaceAll(T,"`"):n}function N(t,n){const e=function(t,n){if("db"===n){const{schemaVersion:n,user:e,likes:o}=t;return JSON.stringify({schemaVersion:n,user:e,likes:o},x)}if("dba"===n)return JSON.stringify(t.authors,x);if("dbv"===n)return JSON.stringify(t.videos);if("dbf"===n)return JSON.stringify(t.following,x);if("dbvd"===n)return JSON.stringify(t.videoDescriptions,x);if("dbb"===n)return JSON.stringify(t.bookmarked,x);throw new Error("invalid dbName")}(t,n);return function(t,n){return n+"=String.raw`"+t+"`;"}(e,n)}function $(t){if(""===t)throw new Error("file is empty");return n=function(t){const n=t.indexOf("{"),e=t.lastIndexOf("}")-t.length+1;return t.slice(n,e)}(t),JSON.parse(n,C);var n}const L="Expected a function",M=NaN,R="[object Symbol]",J=/^\s+|\s+$/g,A=/^[-+]0x[0-9a-f]+$/i,F=/^0b[01]+$/i,W=/^0o[0-7]+$/i,U=parseInt,P="object"==typeof global&&global&&global.Object===Object&&global,q="object"==typeof self&&self&&self.Object===Object&&self,K=P||q||Function("return this")(),z=Object.prototype.toString,H=Math.max,V=Math.min,Q=function(){return K.Date.now()};function X(t,n,e){let o,i,a,r,s,c,u=0,d=!1,l=!1,f=!0;if("function"!=typeof t)throw new TypeError(L);function w(n){const e=o,a=i;return o=i=void 0,u=n,r=t.apply(a,e),r}function h(t){const e=t-c;return void 0===c||e>=n||e<0||l&&t-u>=a}function v(){const t=Q();if(h(t))return y(t);s=setTimeout(v,function(t){const e=n-(t-c);return l?V(e,a-(t-u)):e}(t))}function y(t){return s=void 0,f&&o?w(t):(o=i=void 0,r)}function m(){const t=Q(),e=h(t);if(o=arguments,i=this,c=t,e){if(void 0===s)return function(t){return u=t,s=setTimeout(v,n),d?w(t):r}(c);if(l)return s=setTimeout(v,n),w(c)}return void 0===s&&(s=setTimeout(v,n)),r}return n=Y(n)||0,G(e)&&(d=!!e.leading,l="maxWait"in e,a=l?H(Y(e.maxWait)||0,n):a,f="trailing"in e?!!e.trailing:f),m.cancel=function(){void 0!==s&&clearTimeout(s),u=0,o=c=i=s=void 0},m.flush=function(){return void 0===s?r:y(Q())},m}function Z(t,n,e){let o=!0,i=!0;if("function"!=typeof t)throw new TypeError(L);return G(e)&&(o="leading"in e?!!e.leading:o,i="trailing"in e?!!e.trailing:i),X(t,n,{leading:o,maxWait:n,trailing:i})}function G(t){const n=typeof t;return!!t&&("object"==n||"function"==n)}function Y(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&z.call(t)==R}(t))return M;if(G(t)){const n="function"==typeof t.valueOf?t.valueOf():t;t=G(n)?n+"":n}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(J,"");const n=F.test(t);return n||W.test(t)?U(t.slice(2),n?2:8):A.test(t)?M:+t}const tt={db:!1,dba:!1,dbv:!1,dbvd:!1,dbf:!1,dbb:!1};function nt(t){"mainOrLikes"===t&&(tt.db=!0),"authors"===t&&(tt.dba=!0),"videos"===t&&(tt.dbv=!0),"videoDescriptions"===t&&(tt.dbvd=!0),"following"===t&&(tt.dbf=!0),"bookmarked"===t&&(tt.dbb=!0)}const et=t=>async(n,e)=>{tt[t]&&((new Date).toLocaleTimeString(),await D(await S(e,`data/.appdata/${t}.js`),N(n,t)),tt[t]=!1)},ot=Z(et("db"),5e3),it=Z(et("dba"),5e3),at=Z(et("dbv"),5e3),rt=Z(et("dbvd"),5e3),st=Z(et("dbf"),5e3),ct=Z(et("dbb"),5e3);function ut(t){return!(t.schemaVersion>=5)&&(1===t.schemaVersion&&function(t){t.schemaVersion=2,Object.values(t.following.lastRun).forEach((t=>{t.bottom=t.bottom||t.finish||0}))}(t),2===t.schemaVersion&&function(t){t.schemaVersion=3,t.videoDescriptions=Object.fromEntries(Object.entries(t.videos).map((([t,n])=>[t,n.desc]))),Object.values(t.videos).forEach((t=>delete t.desc))}(t),3===t.schemaVersion&&function(t){t.schemaVersion=4,nt("mainOrLikes"),nt("authors"),nt("videos"),nt("videoDescriptions"),nt("following")}(t),4===t.schemaVersion&&function(t){t.schemaVersion=5,t.bookmarked=E.bookmarked,nt("bookmarked")}(t),!0)}const dt=new class{constructor(){this.u=null,this.l=null}async h(t,n){try{this.u=t,this.l=n,await j(),await O(t),bt("archiveHtml"),bt("rootReadme"),bt("appJs"),ut(n)&&await this.v(),_.i("archiveFolderHandle",t)}catch(t){gt(t,"a27")}}async v(){try{t=this.l,n=this.u,ot(t,n),it(t,n),at(t,n),rt(t,n),st(t,n),ct(t,n)}catch(t){gt(t,"a42")}var t,n}async m(t){var n,e;try{if(!this.l.following.started.has(t)&&!(null===(e=null===(n=this.l.following.authorItems[t])||void 0===n?void 0:n.inFolder)||void 0===e?void 0:e.size))return;this.l.following.started.delete(t),delete this.l.following.authorItems[t],nt("following"),await this.v();let o=await this.u.getDirectoryHandle("data");o=await o.getDirectoryHandle("关注"),await o.removeEntry(t,{recursive:!0})}catch(t){gt(t,"purge failed","silently")}}},lt={storeHandleInIDB:!0,chromeExtensionOrigin:"",mockDownload:!1,allowSkipRecentlyVisitedAuthors:!0};function ft(t,n){sidebar.postMessage({direction:202,type:t,payload:n},lt.chromeExtensionOrigin)}const wt=ft;function ht(t,n){sidebar.postMessage({direction:204,type:t,payload:n},lt.chromeExtensionOrigin)}function vt(t,n){sidebar.postMessage({direction:206,type:t,payload:n},lt.chromeExtensionOrigin)}const yt={p:0,g(t=""){this.p++,dt.v(),wt(34,!1)},_(t,n=""){return t!==this.p}};function mt(t,n,e){ft(1,{err:t,location:n,silently:e})}const pt=Z(mt,500);function gt(t,n,e){e?pt(t,n,e):(mt(t,n,e),yt.g(`because of error @ ${n}`))}const _t={rootReadme:"",archiveHtml:"",appJs:"",backupsReadme:"",crswapReadme:""};async function bt(t){try{const n=_t[t];if(!n)return void gt(new Error(`hasn't received ${t}`),"sa17");switch(t){case"rootReadme":await D(await S(dt.u,"说明.txt"),n);break;case"archiveHtml":await D(await S(dt.u,"本地库.html"),n);break;case"appJs":await D(await S(dt.u,"data/.appdata/app.js"),n);break;case"backupsReadme":await D(await S(dt.u,"data/.appdata/备份/说明.txt"),n);break;case"crswapReadme":await D(await S(dt.u,"data/.appdata/crswap说明.txt"),n)}_t[t]=""}catch(t){throw t.message&&(t.message+=" @ wsa57"),t}}function kt(t){return new Promise((n=>{setTimeout((()=>{n(t)}),t)}))}function St(t,n,e,o){if("a"===e&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof n?t!==n||!o:!n.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===e?o:"a"===e?o.call(t):o?o.value:n.get(t)}function Dt(t,n,e,o,i){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof n?t!==n||!i:!n.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?i.call(t,e):i?i.value=e:n.set(t,e),e}function It(){var t;return(null===(t=null===navigator||void 0===navigator?void 0:navigator.userAgent)||void 0===t?void 0:t.includes("Edg"))?"Edge":"Chrome"}function Ot(){var t,n,e;return null===(e=null===(n=null===(t=null===navigator||void 0===navigator?void 0:navigator.userAgent.match(/Chrome\/(\S+)/))||void 0===t?void 0:t[0])||void 0===n?void 0:n.split("/"))||void 0===e?void 0:e[1]}function jt(){var t,n;return(null===(t=null===navigator||void 0===navigator?void 0:navigator.platform)||void 0===t?void 0:t.includes("Mac"))||(null===(n=null===navigator||void 0===navigator?void 0:navigator.userAgent)||void 0===n?void 0:n.includes("CrOS"))?"":"Windows"}function Et(){const t=(null===navigator||void 0===navigator?void 0:navigator.userAgent)||"",n=(null===navigator||void 0===navigator?void 0:navigator.platform)||"";return/(awemePcClient)|(electron)/i.test(t)?"Mac68K"===n||"MacPPC"===n||"Macintosh"===n||"MacIntel"===n?3:2:1}const Tt={k:"",o(){var t,n,e,o,i;if(this.k)return this.k;const a=(null===(t=window.ssrData)||void 0===t?void 0:t.webId)||(null===(e=null===(n=Ft())||void 0===n?void 0:n.odin)||void 0===e?void 0:e.user_unique_id)||(null===(i=null===(o=Wt())||void 0===o?void 0:o.odin)||void 0===i?void 0:i.user_unique_id);return a&&(this.k=a),a}};function Bt(t="none"){var n,e,o;const i=Tt.o();return i||"webidNotMandatory"===t||(gt(new Error("no webid"),"gcp37"),Kt.S.seriousErrors.push("can't find webid"),Kt.D()),{device_platform:"webapp",aid:"6383",channel:"channel_pc_web",version_code:"170400",version_name:"17.4.0",cookie_enabled:null===navigator||void 0===navigator?void 0:navigator.cookieEnabled,screen_width:null===screen||void 0===screen?void 0:screen.width,screen_height:null===screen||void 0===screen?void 0:screen.height,browser_language:null===navigator||void 0===navigator?void 0:navigator.language,browser_platform:null===navigator||void 0===navigator?void 0:navigator.platform,browser_name:It(),browser_version:Ot(),browser_online:null===navigator||void 0===navigator?void 0:navigator.onLine,engine_name:"Blink",engine_version:Ot(),os_name:jt(),os_version:"Windows"===jt()?"10":"",cpu_core_num:null===navigator||void 0===navigator?void 0:navigator.hardwareConcurrency,device_memory:(null===navigator||void 0===navigator?void 0:navigator.deviceMemory)||"",platform:"PC",downlink:(null===(n=null===navigator||void 0===navigator?void 0:navigator.connection)||void 0===n?void 0:n.downlink)||"",effective_type:(null===(e=null===navigator||void 0===navigator?void 0:navigator.connection)||void 0===e?void 0:e.effectiveType)||"",round_trip_time:(null===(o=null===navigator||void 0===navigator?void 0:navigator.connection)||void 0===o?void 0:o.rtt)||"",pc_client_type:Et(),webid:i}}function xt(){if("not_logged_in"===Pt.I)return{id:null,secUid:null,uniqueId:null,nickname:null};const{uid:t,secUid:n,uniqueId:e,nickname:o}=Pt.O;return{id:t,secUid:n,uniqueId:e,nickname:o}}function Ct(){const{secUid:t}=xt();return{sec_user_id:t,publish_video_strategy_type:"2"}}function Nt(){const{secUid:t,id:n}=xt();return{sec_user_id:t,user_id:n,source_type:4,gps_access:"0",address_book_access:"0",is_top:1}}var $t,Lt,Mt,Rt;class Jt{constructor(t){let n;switch($t.set(this,void 0),t){case"likes":Dt(this,$t,new URL("https://www.douyin.com/aweme/v1/web/aweme/favorite/"),"f"),n={...Bt(),...Ct()};break;case"authors":Dt(this,$t,new URL("https://www.douyin.com/aweme/v1/web/user/following/list/"),"f"),n={...Bt(),...Nt()};break;case"authorItems":Dt(this,$t,new URL("https://www.douyin.com/aweme/v1/web/aweme/post/"),"f"),n={...Bt(),locate_query:"false",publish_video_strategy_type:"2",show_live_replay_strategy:1};break;case"self":Dt(this,$t,new URL("https://www.douyin.com/aweme/v1/web/user/profile/self/"),"f"),n={...Bt("webidNotMandatory"),publish_video_strategy_type:"2",source:"channel_pc_web"};break;case"bookmarked":Dt(this,$t,new URL("https://www.douyin.com/aweme/v1/web/aweme/listcollection/"),"f"),n={...Bt(),publish_video_strategy_type:"2"}}return Object.entries(n).forEach((([t,n])=>{St(this,$t,"f").searchParams.set(t,String(n||""))})),this}j(t){return St(this,$t,"f").searchParams.set("cursor",t),this}T(t){return St(this,$t,"f").searchParams.set("offset",String(t)),this}B({max_cursor:t,min_cursor:n}){return St(this,$t,"f").searchParams.set("max_cursor",String(t)),St(this,$t,"f").searchParams.set("min_cursor",String(n)),this}C(t){return St(this,$t,"f").searchParams.set("max_cursor",String(t)),this}N({min_time:t,max_time:n}){return St(this,$t,"f").searchParams.set("min_time",String(t)),St(this,$t,"f").searchParams.set("max_time",String(n)),this}$(t){return St(this,$t,"f").searchParams.set("count",String(t)),this}L(t){return St(this,$t,"f").searchParams.set("sec_user_id",t),this}M(){return St(this,$t,"f").toString()}}async function At(t,n){const e=t.ok,o=t.status,i=t.headers.get("Content-Type"),a=t.headers.get("content-length");let r="",s=n;if(e)if("0"==a)s+=JSON.stringify({statusCode:o,mime:i,contentLength:a});else if(null==i?void 0:i.includes("text"))r=await t.text(),s+=JSON.stringify({statusCode:o,mime:i,contentLength:a,content:r});else if(null==i?void 0:i.includes("application/json"))try{r=await t.text();return{json:JSON.parse(r),err:null}}catch(t){s+=JSON.stringify({statusCode:o,mime:i,contentLength:a,content:r})}else s+=JSON.stringify({statusCode:o,mime:i,contentLength:a});else s+=JSON.stringify({statusCode:o});return{json:{},err:new Error(s)}}function Ft(){var t,n,e,o,i,a;return(null===(t=window.SSR_RENDER_DATA)||void 0===t?void 0:t.app)||(null===(n=window.SSR_RENDER_DATA_DOC)||void 0===n?void 0:n.app)||(null===(e=window.SSR_RENDER_DATA)||void 0===e?void 0:e[1])||(null===(o=window.SSR_RENDER_DATA_DOC)||void 0===o?void 0:o[1])||(null===(i=window.SSR_RENDER_DATA)||void 0===i?void 0:i.C_0)||(null===(a=window.SSR_RENDER_DATA_DOC)||void 0===a?void 0:a.C_0)}function Wt(){try{const t=document.getElementById("RENDER_DATA"),n=(null==t?void 0:t.innerText)||"",e=n?JSON.parse(decodeURIComponent(n)):{};return e.app||e[1]}catch(t){return gt(t,"ac31","silently"),null}}function Ut(t,n="from unknown"){!(null==t?void 0:t.uniqueId)&&(null==t?void 0:t.shortId)&&(t.uniqueId=t.shortId);return Boolean("number"==typeof(null==t?void 0:t.favoritingCount)&&"number"==typeof(null==t?void 0:t.followingCount)&&(null==t?void 0:t.nickname)&&(null==t?void 0:t.secUid)&&(null==t?void 0:t.uid)&&(null==t?void 0:t.uniqueId))}$t=new WeakMap;const Pt=new(Rt=class{constructor(){Lt.add(this),this.I="unset",this.O={}}async h(){try{await St(this,Lt,"m",Mt).call(this)}catch(t){gt(t,"ac147"),Kt.S.seriousErrors.push(`error in appContext.init_(): ${t}`)}finally{Kt.D()}}},Lt=new WeakSet,Mt=async function(){var t,n;this.I="populating";const e=null===(t=Ft())||void 0===t?void 0:t.user;e||Kt.S.expectedErrors.push('"user" not in window');const o=null===(n=Wt())||void 0===n?void 0:n.user;if(o||Kt.S.expectedErrors.push('"user" not in script tag'),!e&&!o&&window.captchaOptions)return void(this.I="captcha");if(!1===function(){var t,n;const e=(null===(t=Ft())||void 0===t?void 0:t.odin)||(null===(n=Wt())||void 0===n?void 0:n.odin);return e||Kt.S.seriousErrors.push("`odin` not in window or script tag"),void 0===(null==e?void 0:e.user_is_auth)&&Kt.S.seriousErrors.push("`user_is_auth` not in odin"),!0}())return void(this.I="not_logged_in");if(Ut(null==e?void 0:e.info,"from window"))return this.O=e.info,void(this.I="obtained_from_window");if(Kt.S.expectedErrors.push("userProfile not found in window"),Ut(null==o?void 0:o.info,"from script tag"))return this.O=o.info,void(this.I="obtained_from_script_tag");Kt.S.expectedErrors.push("userProfile not found in script tag");const{status:i,value:a}=await async function(){var t,n,e,o,i,a,r;const s=new Jt("self"),c=await fetch(s.M(),{credentials:"include"}),{err:u,json:d}=await At(c,"ac98");if(u)return{status:"error",value:u.message};if("用户未登录"===d.status_msg)return{status:"not_logged_in",value:d};const l={nickname:null===(t=null==d?void 0:d.user)||void 0===t?void 0:t.nickname,secUid:null===(n=null==d?void 0:d.user)||void 0===n?void 0:n.sec_uid,uid:null===(e=null==d?void 0:d.user)||void 0===e?void 0:e.uid,uniqueId:(null===(o=null==d?void 0:d.user)||void 0===o?void 0:o.unique_id)||(null===(i=null==d?void 0:d.user)||void 0===i?void 0:i.short_id),favoritingCount:null===(a=null==d?void 0:d.user)||void 0===a?void 0:a.favoriting_count,followingCount:null===(r=null==d?void 0:d.user)||void 0===r?void 0:r.following_count};return Ut(l,"from fetch")?{status:"fetched",value:l}:{status:"error",value:d}}();if("not_logged_in"!==i)return"error"===i?(Kt.S.seriousErrors.push("fetchSelf error"),Kt.S.fetchSelfResult=a,void(this.I="error")):"fetched"===i?(this.O=a,void(this.I="obtained_from_fetch")):void(this.I="error");this.I="not_logged_in"},Rt);function qt(){const t=new Set(["project"]),n=Object.fromEntries(Object.entries(window).filter((([t,n])=>!!isNaN(Number(t))))),e=(new Set([window]),JSON.stringify(n,(function(n,e){try{if(t.has(n))return;return Array.isArray(e)||function(t){if(!function(t){return"[object Object]"===function(t){return Object.prototype.toString.call(t)}(t)}(t))return!1;const n=Object.getPrototypeOf(t);return n===Object.prototype||null===n}(e)?e:"string"==typeof e?e.substring(0,30):"number"==typeof e?e:void 0}catch(t){return}})));return JSON.parse(e)}const Kt={S:{expectedErrors:[],seriousErrors:[],everythingFromWindow:{},fromScriptTag:{},fetchSelfResult:{}},async D(){var t;if(0!==this.S.seriousErrors.length){this.S,await kt(3e3);try{this.S.everythingFromWindow=qt()}catch(n){this.S.everythingFromWindow={err_serializing_window:null===(t=n)||void 0===t?void 0:t.message},gt(n,"Qmj090","silently")}this.S.fromScriptTag=Wt(),ft(28,{everything:JSON.stringify(this.S),expectedErrors:this.S.expectedErrors,seriousErrors:this.S.seriousErrors})}}},zt={};const Ht=Z((function(){Object.entries(zt).forEach((async([t,n])=>{const e=await S(dt.u,`data/关注/头像/${t}`),o=await e.createWritable();await o.write(n),await o.close(),delete zt[t]}))}),7e3);var Vt,Qt;const Xt=new(Qt=class{constructor(){Vt.set(this,void 0)}async h(){Dt(this,Vt,await _.o("largeVideos")||new Set,"f")}R(t){return St(this,Vt,"f").has(t)}J(t){St(this,Vt,"f").add(t),_.i("largeVideos",St(this,Vt,"f"))}},Vt=new WeakMap,Qt),Zt={A(t,n){ft(2,{event:t,params:n})}};let Gt=0;function Yt(){let t;return t=Gt<=2?5:2+5*(Gt-2),1e3*t}const tn={};async function nn(){const t=[];Object.entries(tn).forEach((async([n,e])=>{const{createTime:o,cover:i,video:a,size:r}=e;if(Boolean(i&&a&&r))t.push(async function(t){const{startWritingToDiskTime:n,key:e,type:o,itemData:{aweme_id:i,author:a},cover:r,video:s,size:c}=t;if(0!==n){return Date.now()-n<15e3?void 0:(delete tn[e],void gt(new Error("stuck in writing"),"ts74","silently"))}t.startWritingToDiskTime=Date.now();try{let t="";switch(o){case"liked":t="data/点赞";break;case"bookmarked":t="data/收藏";break;case"following":t=`data/关注/${a.uid}`;break;default:throw new Error("ts96")}const n=`${t}/封面/${i}.jpg`,e=`${t}/视频/${i}.mp4`,u=S(dt.u,n).then((t=>D(t,r))),d=S(dt.u,e).then((t=>D(t,s)));switch(await Promise.all([u,d]),dt.l.videos[i].size=c,nt("videos"),o){case"liked":{dt.l.likes.downloaded.add(i),nt("mainOrLikes"),wt(11,dt.l.likes.downloaded.size);const t=dt.l.likes.downloaded.size;t%50==0&&ft(24,{total:dt.l.likes.total,numMp4InLocalFolder:t});break}case"bookmarked":dt.l.bookmarked.downloaded.add(i),nt("bookmarked"),wt(31,{numLocalMp4:dt.l.bookmarked.downloaded.size});break;case"following":{const t=dt.l.following.authorItems;t[a.uid].inFolder.add(i),nt("following"),wt(20,{authorId:a.uid,count:t[a.uid].inFolder.size});break}default:throw new Error("ts141")}}catch(t){gt(t,"ts71","silently")}finally{delete tn[e]}}(e));else{Date.now()-o>1e5&&(delete tn[n],Zt.A("took over 100 seconds"))}})),t.length&&(await Promise.allSettled(t),await dt.v())}const en=new class{addNew(t){tn[t.key]=t,Gt=Object.keys(tn).length}F(t,n){tn[t]&&(tn[t].cover=n,nn())}W(t,n){tn[t]&&(tn[t].size=n)}U(t,n){tn[t]&&(tn[t].video=n,nn())}P(t){tn[t],tn[t]&&delete tn[t]}};function on(t){return!Array.isArray(t.images)}function an(t){var n,e,o,i;if(Array.isArray(t.images))return!0;if(!(t.aweme_id&&t.video&&t.author&&t.statistics))return gt(new Error(JSON.stringify(t)),"pid17","silently"),!1;const a=null===(e=null===(n=t.video.play_addr)||void 0===n?void 0:n.url_list)||void 0===e?void 0:e[0],r=null===(i=null===(o=t.video.cover)||void 0===o?void 0:o.url_list)||void 0===i?void 0:i[0];return a?!!r||(gt(new Error("No coverUrl"),"pid30","silently"),!1):(gt(new Error("No videoUrl"),"pid26","silently"),!1)}var rn,sn,cn;class un{constructor(t,n){this.q=t,this.K=n,rn.add(this),this.H=this.q.aweme_id+this.K}get V(){var t,n;switch(this.K){case"liked":return Boolean(dt.l.likes.downloaded.has(this.q.aweme_id));case"bookmarked":return Boolean(dt.l.bookmarked.downloaded.has(this.q.aweme_id));case"following":return Boolean(null===(n=null===(t=dt.l.following.authorItems[this.q.author.uid])||void 0===t?void 0:t.inFolder)||void 0===n?void 0:n.has(this.q.aweme_id));default:throw new Error("bli33")}}get X(){return Xt.R(this.H)}Z(){en.addNew({createTime:Date.now(),startWritingToDiskTime:0,key:this.H,type:this.K,itemData:this.q}),St(this,rn,"m",sn).call(this),St(this,rn,"m",cn).call(this)}G(){try{dt.l.videoDescriptions[this.q.aweme_id]=this.q.desc,nt("videoDescriptions"),dt.l.videos[this.q.aweme_id]=function(t,n){const e={authorId:t.author.uid,createTime:t.create_time,diggCount:t.statistics.digg_count},o=n.videos[t.aweme_id];return Object.assign({},o,e)}(this.q,dt.l),nt("videos"),"following"!==this.K&&(dt.l.authors[this.q.author.uid]=function(t,n){const e={nicknames:[t.author.nickname],uniqueIds:[t.author.unique_id],secUid:t.author.sec_uid,shortId:t.author.short_id},o=n.authors[t.author.uid];o&&(e.uniqueIds=[...new Set([...e.uniqueIds,...o.uniqueIds])],e.nicknames=[...new Set([...e.nicknames,...o.nicknames])]);return Object.assign({},o,e)}(this.q,dt.l),nt("authors"))}catch(t){gt(t,"i77")}}}rn=new WeakSet,sn=function(){vt(0,{tempStorageKey:this.H,url:this.q.video.cover.url_list[0]})},cn=function(){var n,e;n=3,e={tempStorageKey:this.H,url:this.q.video.play_addr.url_list[0]},t.postMessage({direction:200,type:n,payload:e})};const dn={Y:!1};function ln(t,n){return function(t,n){const e=[...n],o=new Set,i=new Set(e);for(const n of t)if(i.has(n)){for(const[t,i]of e.entries())if(o.add(i),i===n){e.splice(0,t);break}}else o.add(n);return e.forEach((t=>o.add(t))),[...o]}(t.slice(-50),n)}function fn(t,n,e){const o=new Set,i=n[n.length-1],a=t.slice(0,t.indexOf(i)+1),r=new Set(n);return a.forEach((t=>{r.has(t)||o.add(t)})),e.forEach((t=>{r.has(t)||o.add(t)})),o}const wn=t=>n=>{const e={};for(const o of t)e[o]=n[o];return e},hn=t=>n=>{const e=new Set;return n.filter((n=>!e.has(n[t])&&(e.add(n[t]),!0)))};function vn(t){const n=wn(["aweme_id","create_time","desc","images"])(t);return n.author=wn(["nickname","sec_uid","short_id","uid","unique_id"])(t.author),n.statistics=wn(["digg_count"])(t.statistics),n.video={cover:{url_list:[t.video.cover.url_list[1]||t.video.cover.url_list[0]]},play_addr:{url_list:[t.video.play_addr.url_list[0]]}},n}function yn(t){const n=wn(["nickname","sec_uid","short_id","uid","unique_id","aweme_count","favoriting_count","follower_count","following_count","signature","total_favorited"])(t);return n.avatar_larger={url_list:[t.avatar_larger.url_list[0]]},n.avatar_thumb={url_list:[t.avatar_thumb.url_list[0]]},n}let mn=Date.now();async function pn(t){const n=Date.now()-mn;if(n<t){const e=t-n;await kt(e)}mn=Date.now()}let gn={};const _n=Z((function(t){const n=gn[t];n?ft(29,JSON.stringify(n)):gt(new Error(`${t} not found`),"tp4rp12","silently")}),2e4),bn={tt(t,n){try{if(!Array.isArray(t))throw new Error("items is not an array");gn={};for(const e of t){const t=e.aweme_id+n;gn[t]=e}}catch(t){gt(t,"t4r19","silently")}},nt(t){_n(t)}};let kn=!1;var Sn,Dn,In,On;const jn=[];let En=0;const Tn={et:0,get ot(){return dt.l.bookmarked.disappeared.size},it(){wt(31,{numDownloadedThenDisappeared:this.ot})},rt(){wt(31,{newDeletionDetected:this.ot-this.et})}};async function*Bn(){jn.length=0,En=0,Tn.et=Tn.ot;for await(const t of async function*(){var t,n;kn=!1;let e=0,o=1;const i={st:0,ct:0,ut:0},a=yt.p;do{await pn(3e3);const r=new Jt("bookmarked");let s=[],c={};try{for(;!navigator.onLine;)await kt(1e3);if(yt._(a,"scroll down bookmarked"))return;const o=new URLSearchParams;o.append("count","10"),o.append("cursor",e.toString());const i=await fetch(r.M(),{credentials:"include",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o});let u=null;if(({json:c,err:u}=await At(i,"Aec549")),u)throw u;if(bn.tt(c.aweme_list,"bookmarked"),s=null===(n=null===(t=c.aweme_list)||void 0===t?void 0:t.map)||void 0===n?void 0:n.call(t,vn),0!=c.status_code)throw new Error("Cec644"+JSON.stringify(c))}catch(t){if(i.st++,i.st<=3){await kt(3e3*i.st);continue}if(!c.cursor||c.cursor==e)return void gt(t,"Hmd633")}if(i.st=0,s){const t=s.some((t=>!an(t)));if(!t&&i.ut>0&&i.ut--,t){if(i.ct++,i.ct<3&&i.ut<3){await kt(3e3*i.ct);continue}i.ut++}if(i.ct=0,0===s.filter(an).length&&s.length>5&&i.ut>=3)return void gt(new Error("今天抖音服务器返回的结果有点奇怪, 休息一下明天再试吧"),"Bjg595");yield s.filter(on)}({cursor:e,has_more:o}=c),o&&0!=e||(kn=!0)}while(o&&0!=e)}()){jn.push(...t),wt(31,{scrolledTo:jn.length}),await xn(jn);for(const n of t)En++,yield n}}async function xn(t){const n=dt.l.bookmarked.masterList.length,e=dt.l.bookmarked.disappeared.size;dt.l.bookmarked.masterList=ln(t.map((t=>t.aweme_id)),dt.l.bookmarked.masterList),dt.l.bookmarked.disappeared=fn(dt.l.bookmarked.masterList,t.map((t=>t.aweme_id)),dt.l.bookmarked.disappeared),n===dt.l.bookmarked.masterList.length&&e===dt.l.bookmarked.disappeared.size||(Tn.rt(),nt("bookmarked"),await dt.v())}const Cn=new(On=class{constructor(){Sn.add(this)}async dt(){const t=yt.p;await St(this,Sn,"m",Dn).call(this);for await(const n of Bn()){if(!an(n))continue;const e=new un(n,"bookmarked");if(e.G(),!e.V&&!e.X){for(;!navigator.onLine;)await kt(1e3);if(yt._(t,"download bookmarked one by one"))return;if(wt(31,{nowAt:En}),e.Z(),await kt(Yt()),!dn.Y)return yt.g("download bookmarked, resync not ready"),void gt(new Error("resync is not ready"),"Lah196")}}yt._(t,"after download bookmarked items")||St(this,Sn,"m",In).call(this)}},Sn=new WeakSet,Dn=async function(){dt.l.bookmarked.lastRun.start=Date.now(),nt("bookmarked"),wt(31,{subView:"downloading",scrolledTo:0,showNowAt:!1,numLocalMp4:dt.l.bookmarked.downloaded.size}),await kt(4e3)},In=function(){kn&&(dt.l.bookmarked.lastRun.finish=Date.now(),dt.l.bookmarked.numDisappeared=dt.l.bookmarked.total-jn.length,nt("bookmarked")),Tn.it(),wt(31,{subView:"done"}),dt.v()},On);async function Nn(t,n){const e=await S(dt.u,`data/关注/头像/${n}`,!1);if(e){const t=await e.getFile();if(t.size>0){const n=6048e5,e=(12*Math.random()+1)*n;if(Date.now()-t.lastModified<e)return}}vt(7,{url:t,filename:n}),n.includes("small")&&await kt(200),n.includes("large")&&await kt(2e3)}const $n=new class{constructor(){this.lt={}}i(t){this.lt=t}};const Ln={o:async()=>await _.o("lastSuccessfulScroll")||0,set(){_.i("lastSuccessfulScroll",Date.now())},async ft(){const t=await this.o();return Date.now()-t<36e5}},Mn={wt:"",ht(){const t=dt.l.following.lastRun[this.wt].bottom,{bottomNoMoreOftenThanDays:n,randomize:e}=$n.lt.preferences,o=24*n*60*60*1e3,i=Date.now()-t;if(!e)return i>o;if(i<o/2)return!1;const a=(i-o/2)/(o/2),r=String(t).slice(-3);return Number(r)/1e3<a},vt:!1,yt:0},Rn={dueToErrorInsideJson:0,gt:0},Jn={_t:!1,bt:0,kt:t=>(null==t?void 0:t.includes('"statusCode":200'))&&(null==t?void 0:t.includes('"mime":"text/plain'))&&(null==t?void 0:t.includes('"contentLength":"0"')),St(){this._t=!1,this.bt=0}};const An=[];let Fn;async function*Wn(t){An.length=0,Fn=0;const n=async function*(t){var n,e;Mn.wt=t.uid,Mn.vt=!1,Mn.yt=0;let o=0,i=1;const a={Dt:0,It:0,ct:0,ut:0},r=yt.p;do{if(await pn(6e3),Mn.yt>=2){0===a.ut&&Rn.gt>0&&Rn.gt--;break}const s=new Jt("authorItems").$(10).C(o).L(t.sec_uid);let c=[],u={};try{for(;!navigator.onLine;)await kt(1e3);if(yt._(r,"scroll down one author"))return;const t=await fetch(s.M(),{credentials:"include"});let n=null;if(({err:n,json:u}=await At(t,"gab92")),n){if(n.message.includes("429")){const t=60;wt(34,!0),await kt(1e3*t),wt(34,!1);continue}if(a.Dt++,gt(n,"gab40","silently"),Jn.kt(n.message)&&Jn.bt++,Jn.bt>=2){for(wt(32),Jn._t=!0;Jn._t;)await kt(1e3);a.Dt=0;continue}if(a.Dt<=3){a.Dt,await Ln.ft()?await kt(1e4*a.Dt):await kt(3e3*a.Dt);continue}if(await Ln.ft()){gt(n,"Kqv133","silently"),Jn.bt++,await kt(3e4);break}return void gt(n,"Xpg140")}if(0!==u.status_code)throw new Error(`api status_code: ${u.status_code}`)}catch(t){if(a.It++,a.It<=3){await kt(3e3*a.It);continue}if(!u.max_cursor||u.max_cursor===o){if(Rn.dueToErrorInsideJson++,Rn.dueToErrorInsideJson<=3){gt(t,"gab52","silently");break}return void gt(t,"gab140")}}if(a.It=0,bn.tt(u.aweme_list,"following"),c=null===(e=null===(n=u.aweme_list)||void 0===n?void 0:n.map)||void 0===e?void 0:e.call(n,vn),c){Ln.set();const n=c.some((t=>!an(t)));if(!n&&a.ut>0&&a.ut--,n){if(a.ct++,a.ct<3&&a.ut<3){await kt(3e3*a.ct);continue}a.ut++}c.length&&(a.ct=0,a.Dt=0,Jn.bt=0);const e=c.filter(an);if(c.length>5&&0===e.length&&a.ut>=3){Rn.gt++,Rn.gt>=3&&gt(new Error("今天抖音服务器返回的结果有点奇怪, 休息一下明天再试吧"),"gab185");break}const o=c.filter(on);Mn.ht()||(o.every((n=>dt.l.following.authorItems[t.uid].inFolder.has(n.aweme_id)))?Mn.yt++:Mn.yt=0),yield o}if(({max_cursor:o,has_more:i}=u),-1===o){gt(new Error(`weird cursor: ${o}`),"fai63","silently");break}i||(Mn.vt=!0,0===a.ut&&Rn.gt>0&&Rn.gt--,await kt(7e3))}while(i)}(t);for(;;){const e=An[Fn];if(e)yield e,Fn++;else{const e=await n.next();if(e.done)break;An.push(...e.value),wt(18,An.length);try{await Pn(t.uid,An)}catch(t){gt(t,"dfo34","silently")}const o=$n.lt.preferences.maxScroll||1e3;if(An.length>=o){Mn.vt=!0;break}}}}async function Un(t){var n,e,o,i;dt.l.following.started.add(t.uid),(n=dt.l.following.authorItems)[e=t.uid]||(n[e]={inFolder:new Set,disappeared:new Set}),wt(18,0),await kt(2500),await kt(2500),await kt(1500),wt(20,{authorId:t.uid,count:dt.l.following.authorItems[t.uid].inFolder.size}),await kt(500),(o=dt.l.following.lastRun)[i=t.uid]||(o[i]={start:0,finish:0,bottom:0}),dt.l.following.lastRun[t.uid].start=Date.now(),nt("following");const a=yt.p;for await(const n of Wn(t)){if(t.uid!==n.author.uid){t.nickname,n.author.nickname;continue}if(yt._(a,"download mp4 from one author"))return;if(!an(n))continue;const e=new un(n,"following");if(e.G(),!e.V&&!e.X){for(;!navigator.onLine;)await kt(1e3);e.Z(),wt(19,Fn+1),await kt(Yt())}}Mn.wt===t.uid&&Mn.vt&&(dt.l.following.lastRun[t.uid].bottom=Date.now()),t.nickname,dt.l.following.lastRun[t.uid].finish=Date.now(),nt("following"),await dt.v()}async function Pn(t,n){if(!dt.l.following.authorItems[t])return;const{inFolder:e,disappeared:o}=dt.l.following.authorItems[t],i=function(t,n,e,o){if(0===t.length)return e;const i=new Set(e),a=t[t.length-1].create_time,r=new Set(t.map((t=>t.aweme_id)));for(const t of n)r.has(t)||o[t].createTime>=a&&i.add(t);for(const t of i)r.has(t)&&i.delete(t);return i}(n,e,o,dt.l.videos);dt.l.following.authorItems[t].disappeared=i,o.size!==i.size&&(wt(26,{authorId:t,quantity:i.size-o.size}),Mn.yt=0,nt("following"),await dt.v())}async function qn(){await kt(3500)}let Kn={},zn=[],Hn={alreadyInArchive:[],willAddToArchive:[],notInterested:[]},Vn=[];function Qn(){const{officialAuthorList:t,started:n,notInterested:e}=dt.l.following;return{numFollowed:t.size,numStarted:n.size,numNotInterested:e.size,numCappedOut:[...t].filter((t=>!n.has(t))).filter((t=>!e.has(t))).length}}function Xn(t){t&&Math.random()>.2||ft(21,Qn())}function Zn(){var t;ft(23,"following"),zn=Vn.sort(((t,n)=>{var e,o;return((null===(e=dt.l.following.lastRun[t])||void 0===e?void 0:e.finish)||0)-((null===(o=dt.l.following.lastRun[n])||void 0===o?void 0:o.finish)||0)})).map((t=>({authorId:t,status:"queued"}))),(null===(t=$n.lt.profile.uid)||void 0===t?void 0:t.includes("x4HbWZBt"))&&zn.length>300&&(zn.length=300),async function(){const t=yt.p;for(;;){if(yt._(t,"move from author to author"))return;0===zn.length&&ft(17,zn);const n=zn.find((t=>"queued"===t.status));if(!n)break;n.status="current",ft(17,zn);const e=Kn[n.authorId];try{await Un(e),await qn()}catch(t){gt(t,"ff96","silently")}n.status="finished",Xn("maybe")}yt._(t,"after moving from author to author")||ft(22,Qn())}().catch((t=>gt(t,"Oic631")))}const Gn={async dt(){try{if(Object.keys(Kn).length>0);else{wt(30,Pt.O.followingCount);const e=await async function(){let t=[],n=0,e=0,o=!0,[i,a]=[0,0];const r=yt.p;do{await pn(2e3);const s=new Jt("authors").$(20).T(n).N({min_time:i,max_time:a});try{for(;!navigator.onLine;)await kt(1e3);if(yt._(r,"fetch list of followed authors"))return null;const e=await window.fetch(s.M(),{credentials:"include"}),{err:c,json:u}=await At(e,"fa34");if(c)throw c;const{status_code:d,followings:l}=u;if(0!==d)throw new Error(`Err fetching authors, ${JSON.stringify(u)}`);l&&l.length>0&&(t.push(...l.map(yn)),t=hn("uid")(t)),({offset:n,has_more:o,min_time:i,max_time:a}=u),wt(15,{currentTotal:t.length})}catch(t){if(e++<3)continue;throw t}if(e=0,0===t.length)return[]}while(o);return t}();if(!e)return;if(!dn.Y)throw new Error("resync is not ready - this should be a one-time error, reload to fix.");Kn=(n="uid",t=>{const e={};return t.forEach((t=>{e[t[n]]=t})),e})(e),(t=e).forEach((t=>{const{uid:n,unique_id:e,nickname:o,signature:i,sec_uid:a,short_id:r,aweme_count:s,follower_count:c}=t,u={uniqueIds:[e],nicknames:[o],followerCount:c,videoCount:s,signature:i,secUid:a,shortId:r},d=dt.l.authors[n];d&&(u.uniqueIds=[...new Set([e,...d.uniqueIds])],u.nicknames=[...new Set([o,...d.nicknames])]),dt.l.authors[n]=u,nt("authors")})),dt.l.following.officialAuthorList=new Set(t.map((t=>t.uid))),nt("following"),dt.v(),async function(t){for(const n of t){const{uid:t,avatar_thumb:e}=n;await Nn(e.url_list[0],`small_${t}.jpg`)}for(const n of t){const{uid:t,avatar_larger:e}=n;await Nn(e.url_list[0],`large_${t}.jpg`)}}(e)}Object.entries(Kn).forEach((([t,n])=>{var e;n.last_checked=(null===(e=dt.l.following.lastRun[t])||void 0===e?void 0:e.finish)||0})),wt(16,{authorDict:Kn,started:[...dt.l.following.started],notInterested:[...dt.l.following.notInterested]})}catch(t){gt(t,"ff27")}var t,n},async Ot(t){Hn=t,dt.l.following.notInterested=new Set(t.notInterested),nt("following"),await dt.v(),Xn(),async function(){for(const t of dt.l.following.officialAuthorList)Hn.alreadyInArchive.includes(t)||Hn.willAddToArchive.includes(t)||await dt.m(t)}(),Vn=[...t.willAddToArchive,...t.alreadyInArchive],Vn.length>50&&lt.allowSkipRecentlyVisitedAuthors?wt(33,Vn):Zn()},jt(t){t.length,Vn=t,Zn()}};let Yn=!1;var te,ne,ee,oe,ie;const ae=[];let re=0;const se={et:0,get ot(){return dt.l.likes.disappeared.size},it(){wt(25,this.ot)},rt(){wt(27,this.ot-this.et)}};async function*ce(){ae.length=0,re=0,se.et=se.ot;for await(const t of async function*(){var t,n;Yn=!1;let[e,o]=[0,0],i=1;const a={st:0,ct:0,ut:0},r=yt.p;do{await pn(2500);const s=new Jt("likes").B({max_cursor:e,min_cursor:o}).$(10);let c=[],u={};try{let e=null;for(;!navigator.onLine;)await kt(1e3);if(yt._(r,"scroll down likes"))return;const o=await fetch(s.M(),{credentials:"include"});if(({json:u,err:e}=await At(o,"gbo36")),e)throw e;if(bn.tt(u.aweme_list,"likes"),c=null===(n=null===(t=u.aweme_list)||void 0===t?void 0:t.map)||void 0===n?void 0:n.call(t,vn),0!==u.status_code)throw new Error(`code: ${u.status_code}, msg: ${u.status_msg}`)}catch(t){if(a.st++<5){await kt(3e3*a.st);continue}if(!u.max_cursor||u.max_cursor===e){gt(t,"fls35");break}}if(a.st=0,c){const t=c.some((t=>!an(t)));if(!t&&a.ut>0&&a.ut--,t){if(a.ct++,a.ct<3&&a.ut<3){await kt(3e3*a.ct);continue}a.ut++}if(a.ct=0,0===c.filter(an).length&&c.length>5&&a.ut>=3){gt(new Error("今天抖音服务器返回的结果有点奇怪, 休息一下明天再试吧"),"fl76");break}yield c.filter(on)}if(u.min_cursor&&(o=u.min_cursor),o&&gt(new Error(`min_cursor not 0!: ${o}`),"fl78","silently"),({max_cursor:e,has_more:i}=u),-1===e){gt(new Error(`weird cursor: ${e}`),"fl81","silently"),yt.g("scroll down likes list, cursor -1");break}i||(Yn=!0)}while(i)}()){ae.push(...t),wt(9,ae.length),await de(ae);for(const n of t)re++,yield n}}const ue=new(ie=class{constructor(){te.add(this)}async dt(){const t=yt.p;await St(this,te,"m",ee).call(this);let n=!1;for await(const e of ce()){if(!an(e))continue;const o=new un(e,"liked");if(o.G(),!n&&!o.V&&!o.X)if(St(this,te,"a",ne))n=!0,wt(8,"downloading(capped)");else{for(;!navigator.onLine;)await kt(1e3);if(yt._(t,"loop download liked items"))return;if(o.Z(),wt(10,re),await kt(Yt()),!dn.Y)return yt.g("resync is not ready"),void gt(new Error("resync is not ready"),"ll88")}}yt._(t,"after loop download liked items")||(0===ae.length?wt(13):n?St(this,te,"m",oe).call(this,"done(capped)"):St(this,te,"m",oe).call(this,"done"))}},te=new WeakSet,ne=function(){return dt.l.likes.downloaded.size>=function(){try{return function(t){const n=5e3;if(0===t)return{cap:1e3,nextToBuy:"下载1001至5000个点赞作品",lineItemDescription:'"购买后, 下载抖音点赞作品到本地mp4的数目可以超过1000, 最多5000"'};const e=n*t,o=e+n;return{cap:e,nextToBuy:`下载${e+1}至${o}个点赞作品`,lineItemDescription:`"购买后, 下载抖音点赞作品到本地mp4的数目可以超过${e}, 最多${o}"`}}($n.lt.unlocks.likeLevel).cap}catch(t){return gt(t,"ud17"),0}}()},ee=async function(){dt.l.likes.lastRun.start=Date.now(),dt.l.likes.total=Pt.O.favoritingCount||0,nt("mainOrLikes"),wt(12,Pt.O.favoritingCount),wt(11,dt.l.likes.downloaded.size),wt(9,0),wt(8,"downloading"),await kt(4e3),ft(23,"likes")},oe=function(t){Yn&&(dt.l.likes.lastRun.finish=Date.now(),dt.l.likes.numDisappeared=dt.l.likes.total-ae.length,nt("mainOrLikes")),se.it(),dt.v();ft(14,{total:dt.l.likes.total,officialListLength:ae.length,numMp4InLocalFolder:dt.l.likes.downloaded.size,status:t}),wt(8,t)},ie);async function de(t){const n=dt.l.likes.masterList.length,e=dt.l.likes.disappeared.size;dt.l.likes.masterList=ln(t.map((t=>t.aweme_id)),dt.l.likes.masterList),dt.l.likes.disappeared=fn(dt.l.likes.masterList,t.map((t=>t.aweme_id)),dt.l.likes.disappeared),n===dt.l.likes.masterList.length&&e===dt.l.likes.disappeared.size||(se.rt(),nt("mainOrLikes"),await dt.v())}function le(t){wt(5,t)}let fe,we=!1;async function he(t,n){const e=await S(t,n),o=await e.getFile();return await o.text()}async function ve(t){const n=await he(t,"data/.appdata/dba.js");return""===n?E.authors:$(n)}async function ye(t){const n=await he(t,"data/.appdata/dbv.js");return""===n?E.videos:$(n)}async function me(t){const n=await he(t,"data/.appdata/dbf.js");return""===n?E.following:$(n)}async function pe(t){const n=await he(t,"data/.appdata/dbvd.js");return""===n?E.videoDescriptions:$(n)}async function ge(t){try{const n=await he(t,"data/.appdata/db.js"),{id:e,uid:o,uniqueId:i,nickname:a}=$n.lt.profile;let r;if(""===n)r=E,nt("mainOrLikes"),nt("authors"),nt("videos"),nt("videoDescriptions"),nt("following"),nt("bookmarked");else{if(r=$(n),r.user.id.length>0&&r.user.id!==e)return le({folderStatus:"belongs_to_another_douyin_account",belongsToUser:r.user.nickname}),null;if(r.schemaVersion>=4){const[n,e,o,i]=await Promise.all([ve(t),ye(t),me(t),pe(t)]);r.authors=n,r.videos=e,r.following=o,r.videoDescriptions=i}if(r.schemaVersion>=5){const n=await async function(t){const n=await he(t,"data/.appdata/dbb.js");return""===n?E.bookmarked:$(n)}(t);r.bookmarked=n}}return r.user={uid:o,id:e,uniqueId:i,nickname:a},nt("mainOrLikes"),r}catch(t){return le({folderStatus:"corrupted"}),gt(t,"@vd59","silently"),null}}function _e(t){if(!dt.u)return fe=t,void wt(4);try{switch(t||fe){case"likes":ue.dt();break;case"following":Gn.dt();break;case"bookmarked":Cn.dt();break;default:throw new Error("whatToDownload is undefined")}}catch(t){return void gt(t,"db116")}}async function be(){const t=await _.o("archiveFolderHandle");le({folderStatus:"awaiting_os_window"});try{!async function(t){if("granted"!==await t.requestPermission({mode:"readwrite"}))return void le({folderStatus:"not_provided"});if(le({folderStatus:"success"}),await kt(100),!await async function(t){if(await b(t))return!!we||(we=!0,!$n.lt.behavior.hasCreatedArchiveFolder||(le({folderStatus:"unexpectedly_empty"}),!1));try{await t.getFileHandle("本地库.html");const n=await t.getDirectoryHandle("data"),e=await n.getDirectoryHandle(".appdata");return await e.getFileHandle("app.js"),!0}catch(t){return le({folderStatus:"content_seems_wrong"}),!1}}(t))return;const n=await ge(t);if(!n)return;dn.Y||ht("is_resync_ready");try{await dt.h(t,n),await Xt.h()}catch(t){return void gt(t,"db110")}_e()}(await showDirectoryPicker({startIn:t,mode:"readwrite"}))}catch(t){le({folderStatus:"not_provided"})}}function ke(t,e,o){n.postMessage({type:"compare",payload:{myUrl:t,officialUrl:e,category:o}})}function Se(t){const{category:n,payload:e}=t.data;if("official_douyin_likes"===n){ke(new Jt("likes").B({max_cursor:0,min_cursor:0}).$(10).M(),e.officialUrl,n)}if("official_douyin_followed_authors"===n){ke(new Jt("authors").$(20).T(0).N({min_time:0,max_time:0}).M(),e.officialUrl,n)}if("official_douyin_followed_authors_items"===n){ke(new Jt("authorItems").$(10).C(0).L("foo").M(),e.officialUrl,n)}if("official_douyin_bookmarked"===n){ke(new Jt("bookmarked").M(),e.officialUrl,n)}}function De(){var e,o;yt.g("close app"),null===(e=document.getElementById("douzhencang-container"))||void 0===e||e.remove(),null===(o=document.querySelector("#root"))||void 0===o||o.classList.remove("pushed-by-douzhencang"),window.onmessage=null,t.onmessage=null,t.close(),n.onmessage=null,n.close()}async function Ie(n){try{const{type:e}=n.data;if(10===e)return void("www.douyin.com"===location.hostname&&self===top&&"/"===location.pathname&&t.postMessage({type:11}));if(11===e)return void("www.douyin.com"===location.hostname&&self===top&&"/"===location.pathname&&(De(),alert("抖珍藏已在另一页面运行, 本次不再加载。")))}catch(t){gt(t,"om41")}}async function Oe(t){const{origin:n,data:{direction:e,type:o,payload:i}}=t;if(n===lt.chromeExtensionOrigin){if(207===e)try{1===o&&en.F(i.tempStorageKey,i.arrayBuffer),2===o&&en.P(i.tempStorageKey),8===o&&(a=i.blob,r=i.filename,zt[r]=a,Ht())}catch(t){gt(t,"om101")}var a,r,s;if(201===e){if(!dn.Y)return;try{if(4===o){const{tempStorageKey:t,arrayBuffer:n,size:e}=i;en.W(t,e),ht("please_resync_this_video",{tempStorageKey:t,arrayBuffer:n})}if(5===o){const{tempStorageKey:t}=i;en.P(t)}if(6===o){const{tempStorageKey:t}=i;Xt.J(t)}if(12===o){const{tempStorageKey:t}=i;bn.nt(t)}}catch(t){gt(t,"om112")}}if(205===e)try{if("resync_is_ready"===o&&(dn.Y=!0),"resynced"===o){const{tempStorageKey:t,arrayBuffer:n}=i;en.U(t,n)}}catch(t){gt(t,"om127")}if(203===e)try{switch(o){case 8:be();break;case 1:_e("likes");break;case 14:_e("bookmarked");break;case 2:_e("following");break;case 3:De();break;case 4:s=i,Object.assign(_t,s);break;case 0:wt(0,"2.6.8"),gt(new Error("装载ui3, 请等待10秒后手动刷新页面"),"om159"),"unset"===Pt.I&&await Pt.h(),"captcha"===Pt.I?gt(new Error("captcha"),"om174"):"error"===Pt.I?gt(new Error("未检测到您的抖音账号"),"om177"):wt(3,xt()),Pt.I;break;case 5:$n.i(i);break;case 6:try{Gn.Ot(i)}catch(t){gt(t,"om161")}break;case 7:window.open(`https://www.douyin.com/user/${i}/`);break;case 9:location.href="https://www.douyin.com";break;case 11:Jn.St();break;case 10:location.href="https://douzhencang.com";break;case 12:yt.g("requested by ui");break;case 13:Kt.S.seriousErrors.push("triggered by user click on ui"),Kt.D();break;case 15:Gn.jt(i)}}catch(t){gt(t,"om201")}}}async function je(t){const{origin:n,data:{type:e,payload:o}}=t;n===lt.chromeExtensionOrigin&&(0===e&&async function(t,n){try{const e=await fetch(t,{credentials:"include"}),o=e.headers.get("Content-Type");if(!(null==o?void 0:o.startsWith("image")))throw new Error(`cover type is ${o}`);const i=await e.arrayBuffer();parent.postMessage({direction:207,type:1,payload:{arrayBuffer:i,tempStorageKey:n}},lt.chromeExtensionOrigin)}catch(t){if(parent.postMessage({direction:207,type:2,payload:{tempStorageKey:n}},lt.chromeExtensionOrigin),t.message.includes("application/json"))return;parent.postMessage({direction:208,type:1,payload:{err:t,location:"fc18",silently:"silently"}},lt.chromeExtensionOrigin)}}(o.url,o.tempStorageKey),7===e&&async function(t,n){try{const e=await fetch(t,{credentials:"include"}),o=e.headers.get("Content-Type");if(!(null==o?void 0:o.startsWith("image")))throw new Error(`cover type is ${o}`);const i=await e.blob();parent.postMessage({direction:207,type:8,payload:{blob:i,filename:n}},lt.chromeExtensionOrigin)}catch(t){parent.postMessage({direction:208,type:1,payload:{err:t,location:"fa24",silently:"silently"}},lt.chromeExtensionOrigin)}}(o.url,o.filename))}const Ee=document.getElementById("douzhencang-script-tag");if(lt.chromeExtensionOrigin="chrome-extension://"+Ee.getAttribute("data-extension-id"),"www.douyin.com"===location.hostname)try{t.onmessage=Ie,window.onmessage=Oe,n.onmessage=Se,t.postMessage({type:10})}catch(t){gt(t,"st8")}else window.onmessage=je;
